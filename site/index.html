<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Concorrência para Residência Médica 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    /* Ajustes de layout só da home (não mexe no styles.css existente) */
    .page-header { padding: 28px 24px; border-radius: 12px; background: var(--card); }
    .page-header h1 { margin: 0 0 6px }
    .subtle { color: var(--muted); font-size: 0.92rem }
    .actions { margin-top: 14px; display: flex; gap: 12px; flex-wrap: wrap }
    .btn { padding: 10px 14px; border-radius: 10px; background: var(--primary); color: #fff; border: 0; cursor: pointer }
    .btn.alt { background: transparent; color: var(--text); border: 1px solid var(--border) }
    .toolbar { margin: 22px 0 10px; display: grid; grid-template-columns: 1fr auto; gap: 12px; align-items: center }
    .search { background: var(--card); border: 1px solid var(--border); border-radius: 10px; padding: 10px 12px; color: var(--text) }
    .grid { display: grid; gap: 14px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px; display: flex; flex-direction: column; gap: 10px }
    .card h3 { margin: 0; font-size: 1.05rem }
    .pill { display: inline-block; font-size: .82rem; padding: 4px 8px; border-radius: 999px; background: rgba(255,255,255,.04); border:1px solid var(--border); color: var(--muted) }
    .card .meta { display: flex; gap: 8px; flex-wrap: wrap }
    .card .foot { display: flex; gap: 8px; margin-top: 6px }
    .muted { color: var(--muted) }
    .empty { margin: 32px 0; color: var(--muted) }
    .container { max-width: 980px; margin: 28px auto 60px; padding: 0 16px }
    a.btn, a.link { text-decoration: none }
  </style>
  <script>
    // Config da home: reaproveita os mesmos caminhos do projeto
    window.CONCORRENCIA_CONFIG = {
      jsonPath: "data/concorrencia_2026.json",
      downloadsPath: "downloads/",
      allExcelFilename: "concorrencia_2026.xlsx",
      fonteUrl: "https://med.estrategia.com/portal/residencia-medica/concorrencia-residencia-medica/"
    };
  </script>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <h1>Concorrência para Residência Médica 2026</h1>
      <div class="subtle">Atualizado em: <span id="updatedAt">—</span></div>
      <div class="actions">
        <button id="btnExtrairTodos" class="btn" type="button">Extrair todos</button>
      </div>
    </header>

    <div class="toolbar">
      <input id="busca" class="search" type="search" placeholder="Buscar instituição…" autocomplete="off" />
      <div class="muted" id="countHint">0 instituições</div>
    </div>

    <section id="grid" class="grid" aria-label="Lista de instituições"></section>

    <p class="muted" style="margin-top: 22px;">
      Em construção
    </p>
  </div>

  <script>
    (function () {
      const cfg = window.CONCORRENCIA_CONFIG || {};
      const JSON_PATH = cfg.jsonPath || "data/concorrencia_2026.json";
      const DOWNLOADS_PATH = cfg.downloadsPath || "downloads/";
      const ALL_XLSX_NAME = cfg.allExcelFilename || "concorrencia_2026.xlsx";

      const $updatedAt = document.getElementById("updatedAt");
      const $grid = document.getElementById("grid");
      const $busca = document.getElementById("busca");
      const $countHint = document.getElementById("countHint");
      const $btnExtrairTodos = document.getElementById("btnExtrairTodos");
      const $linkFonte = document.getElementById("linkFonte");

      function sanitizeFileNameFromTitle(title) {
        const base = (title || "").toString().replace(/[^\w\s-]/g, "_").trim() || "tabela";
        const cut = base.length > 40 ? base.slice(0, 40) : base;
        return `${cut}.xlsx`;
      }

      function ensureAndDownload(url) {
        return fetch(url, { method: "HEAD", cache: "no-store" })
          .then(resp => { if (!resp.ok) throw 0; window.location.href = url; })
          .catch(() => alert("Arquivo ainda não está disponível. Tente novamente em alguns instantes."));
      }

      function slugify(s) {
        return (s || "").toString()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^\w\s-]/g, "")
          .trim().replace(/\s+/g, "-").toLowerCase();
      }

      function renderList(blocks, q = "") {
        const term = q.trim().toLowerCase();
        const filtered = term
          ? blocks.filter(b => (b.titulo || "").toLowerCase().includes(term))
          : blocks.slice();

        $grid.innerHTML = "";
        if (!filtered.length) {
          $grid.insertAdjacentHTML("beforeend",
            `<div class="empty">Nenhuma instituição encontrada para “${q}”.</div>`);
        } else {
          filtered.forEach(b => {
            const titulo = b.titulo || "Instituição";
            const linhas = Array.isArray(b.rows) ? b.rows.length : 0;
            const colunas = Array.isArray(b.columns) ? b.columns.length : 0;
            const slug = slugify(titulo);
            const fileName = sanitizeFileNameFromTitle(titulo);
            const href = `instituicao.html?t=${encodeURIComponent(titulo)}&s=${slug}`;

            const card = `
              <article class="card" aria-label="${titulo}">
                <h3>${titulo}</h3>
                <div class="meta">
                  <span class="pill">${linhas} linha(s)</span>
                  <span class="pill">${colunas} coluna(s)</span>
                </div>
                <div class="foot">
                  <a class="btn" href="${href}">Abrir</a>
                  <button class="btn alt" data-dl="${fileName}">Baixar modelo</button>
                </div>
              </article>
            `;
            $grid.insertAdjacentHTML("beforeend", card);
          });

          // bind download buttons
          $grid.querySelectorAll('[data-dl]').forEach(btn => {
            btn.addEventListener("click", (ev) => {
              const fn = ev.currentTarget.getAttribute("data-dl");
              ensureAndDownload(`${DOWNLOADS_PATH}${fn}`);
            });
          });
        }
        $countHint.textContent = `${filtered.length} instituição(ões)`;
      }

      async function boot() {
        try {
          const resp = await fetch(JSON_PATH, { cache: "no-store" });
          if (!resp.ok) throw new Error("Falha ao carregar JSON");
          const payload = await resp.json();

          if ($linkFonte && payload.fonte_url) $linkFonte.href = payload.fonte_url;
          if ($updatedAt) $updatedAt.textContent = payload.updated_at_br || "—";

          const blocks = Array.isArray(payload.tabelas) ? payload.tabelas : [];
          renderList(blocks);

          $busca.addEventListener("input", (e) => renderList(blocks, e.target.value));
          if ($btnExtrairTodos) {
            $btnExtrairTodos.onclick = () =>
              ensureAndDownload(`${DOWNLOADS_PATH}${ALL_XLSX_NAME}`);
          }
        } catch (err) {
          console.error(err);
          $grid.innerHTML = `<div class="empty">Erro ao carregar os dados. Tente novamente mais tarde.</div>`;
        }
      }

      document.readyState === "loading"
        ? document.addEventListener("DOMContentLoaded", boot)
        : boot();
    })();
  </script>
</body>
</html>

