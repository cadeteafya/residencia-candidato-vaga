<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Concorrência para Residência Médica 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

  <script>
    window.CONCORRENCIA_CONFIG = {
      jsonPath: "data/concorrencia_2026.json",
      downloadsPath: "downloads/",
      allExcelFilename: "concorrencia_2026.xlsx"
    };
<script>
(function () {
  const JSON_REL = "data/concorrencia_2026.json";
  const DOWNLOADS_PATH = "downloads/";
  const ALL_XLSX_NAME = "concorrencia_2026.xlsx";

  const $updatedAt = document.getElementById("updatedAt");
  const $grid      = document.getElementById("grid");
  const $busca     = document.getElementById("busca");
  const $countHint = document.getElementById("countHint");
  const $btnAll    = document.getElementById("btnExtrairTodos");

  // ---------- utils ----------
  function repoBasePath(){ const p=location.pathname.split("/"); return "/"+(p[1]||""); }
  function jsonURL(){ return `${location.origin}${repoBasePath()}/${JSON_REL}?v=${Date.now()}`; }

  const EMDASH = /\s+[—-]\s+/;
  const YEAR   = /\b20\d{2}(?:\/20\d{2})?\b/g;
  const GENERIC = /^(concorr[eê]ncia|relação candidato\/vaga|programas|prova)/i;

  function nrm(s){ return (s||"").replace(/\s+/g," ").trim(); }
  function instFromTitle(title){
    let t = nrm(title);
    if(!t) return "Instituição";
    const parts = t.split(EMDASH);
    let base = (parts[0]||"").trim();
    if (GENERIC.test(base) && parts.length>1) base = parts[parts.length-1].trim();
    base = base.replace(YEAR,"").replace(/^[\W_]+/,"").trim();
    return base || t;
  }
  function slugify(s){
    return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^\w\s-]/g,"").trim().replace(/\s+/g,"-").toLowerCase();
  }
  function packFilenameByInst(instName){
    return `concorrencia_2026__${slugify(instName)}.xlsx`;
  }

  // render
  function groupByInstitution(blocks){
    const map = new Map();
    for(const b of blocks){
      const inst = instFromTitle(b.titulo||"");
      const slug = slugify(inst);
      if(!map.has(slug)) map.set(slug, { slug, name: inst, tables: [], rows:0, cols:0 });
      const g = map.get(slug);
      g.tables.push(b);
      g.rows += Array.isArray(b.rows) ? b.rows.length : 0;
      g.cols = Math.max(g.cols, Array.isArray(b.columns) ? b.columns.length : 0);
    }
    return Array.from(map.values()).sort((a,b)=>a.name.localeCompare(b.name,'pt-BR'));
  }

  function renderList(groups, q=""){
    const term = (q||"").toLowerCase().trim();
    const list = term ? groups.filter(g => g.name.toLowerCase().includes(term)) : groups;

    $grid.innerHTML = "";
    if(!list.length){
      $grid.insertAdjacentHTML("beforeend", `<div class="empty">Nenhuma instituição encontrada para “${q}”.</div>`);
      $countHint.textContent = "0 instituição(ões)";
      return;
    }

    for(const g of list){
      const instHref = `instituicao.html?g=${encodeURIComponent(g.slug)}`;
      const instXlsx = DOWNLOADS_PATH + packFilenameByInst(g.name);
      const card = `
        <article class="card" aria-label="${g.name}">
          <h3>${g.name}</h3>
          <div class="meta">
            <span class="pill">${g.tables.length} tabela(s)</span>
            <span class="pill">${g.rows} linha(s)</span>
            <span class="pill">${g.cols} coluna(s)</span>
          </div>
          <div class="foot">
            <a class="btn" href="${instHref}">Abrir</a>
            <a class="btn alt js-extract" href="${instXlsx}" download>Extrair</a>
          </div>
        </article>`;
      $grid.insertAdjacentHTML("beforeend", card);
    }
    $countHint.textContent = `${list.length} instituição(ões)`;
  }

  async function boot(){
    try{
      const r = await fetch(jsonURL(), {cache:"no-store"});
      if(!r.ok) throw new Error(`Falha ao carregar JSON (${r.status})`);
      const payload = await r.json();

      if($updatedAt) $updatedAt.textContent = payload.updated_at_br || "—";

      const blocks = Array.isArray(payload.tabelas) ? payload.tabelas : [];
      const groups = groupByInstitution(blocks);
      renderList(groups);

      if($busca) $busca.addEventListener("input", e => renderList(groups, e.target.value));
      if($btnAll) $btnAll.addEventListener("click", e => {
        e.preventDefault();
        window.location.href = DOWNLOADS_PATH + ALL_XLSX_NAME;
      });
    }catch(err){
      console.error(err);
      $grid.innerHTML = `<div class="empty">Erro ao carregar os dados. Tente novamente mais tarde.</div>`;
    }
  }

  document.readyState==="loading" ? document.addEventListener("DOMContentLoaded", boot) : boot();
})();
</script>

</body>
</html>










