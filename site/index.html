<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Concorrência para Residência Médica 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
<style>
  :root {
    --bg: #f9f9fb;
    --card: #ffffff;
    --text: #1a1a1a;
    --muted: #666;
    --border: #e5e5e9;
    --primary: #ff4081; /* rosa elegante */
    --primary-hover: #e63773;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: "Inter", "Segoe UI", Roboto, sans-serif;
    line-height: 1.5;
  }

  .container {
    max-width: 980px;
    margin: 28px auto 60px;
    padding: 0 16px;
  }

  /* topo */
  .page-header {
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    padding: 32px 28px;
  }
  .page-header h1 {
    margin: 0 0 6px;
    font-size: 1.9rem;
    color: var(--text);
  }
  .subtle {
    color: var(--muted);
    font-size: 0.95rem;
  }

  /* botões */
  .btn {
    display: inline-block;
    padding: 10px 16px;
    border-radius: 10px;
    background: var(--primary);
    color: #fff;
    border: none;
    cursor: pointer;
    font-weight: 500;
    text-decoration: none;
    transition: all 0.2s ease;
  }
  .btn:hover {
    background: var(--primary-hover);
    transform: translateY(-1px);
  }
  .btn.alt {
    background: transparent;
    color: var(--primary);
    border: 1.5px solid var(--primary);
  }
  .btn.alt:hover {
    background: var(--primary);
    color: #fff;
  }

  .actions {
    margin-top: 14px;
    display: flex;
    gap: 12px;
    flex-wrap: wrap;
  }

  /* barra de busca */
  .toolbar {
    margin: 26px 0 14px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    align-items: center;
  }
  .search {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 12px 14px;
    font-size: 0.95rem;
    color: var(--text);
    transition: box-shadow 0.2s ease;
  }
  .search:focus {
    outline: none;
    box-shadow: 0 0 0 3px rgba(255, 64, 129, 0.15);
  }
  .muted {
    color: var(--muted);
  }

  /* grid de cards */
  .grid {
    display: grid;
    gap: 18px;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  }
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 20px 18px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.03);
    transition: box-shadow 0.2s ease;
  }
  .card:hover {
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
  }
  .card h3 {
    margin: 0;
    font-size: 1.05rem;
    color: var(--text);
  }

  /* metadados */
  .pill {
    display: inline-block;
    font-size: 0.82rem;
    padding: 5px 10px;
    border-radius: 999px;
    background: #f5f5f5;
    color: var(--muted);
    border: 1px solid var(--border);
  }
  .card .meta {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
  }
  .card .foot {
    display: flex;
    gap: 8px;
    margin-top: 6px;
  }

  /* estados */
  .empty {
    margin: 40px 0;
    text-align: center;
    color: var(--muted);
  }
</style>

  <script>
    window.CONCORRENCIA_CONFIG = {
      jsonPath: "data/concorrencia_2026.json",
      downloadsPath: "downloads/",
      allExcelFilename: "concorrencia_2026.xlsx"
    };
  </script>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <h1>Concorrência para Residência Médica 2026</h1>
      <div class="subtle">Atualizado em: <span id="updatedAt">—</span></div>
      <div class="actions">
        <button id="btnExtrairTodos" class="btn" type="button">Extrair todos</button>
      </div>
    </header>

    <div class="toolbar">
      <input id="busca" class="search" type="search" placeholder="Buscar instituição…" autocomplete="off" />
      <div class="muted" id="countHint">0 instituições</div>
    </div>

    <section id="grid" class="grid" aria-label="Lista de instituições"></section>
  </div>

  <script>
    (function () {
      const cfg = window.CONCORRENCIA_CONFIG || {};
      const JSON_REL = cfg.jsonPath || "data/concorrencia_2026.json";
      const DOWNLOADS_PATH = cfg.downloadsPath || "downloads/";
      const ALL_XLSX_NAME = cfg.allExcelFilename || "concorrencia_2026.xlsx";

      const $updatedAt = document.getElementById("updatedAt");
      const $grid = document.getElementById("grid");
      const $busca = document.getElementById("busca");
      const $countHint = document.getElementById("countHint");
      const $btnExtrairTodos = document.getElementById("btnExtrairTodos");

      function repoBasePath() {
        const parts = location.pathname.split("/");
        return "/" + (parts[1] || "");
      }
      function jsonURL() {
        return `${location.origin}${repoBasePath()}/${JSON_REL}?v=${Date.now()}`;
      }
      function slugify(s) {
        return (s || "").toString()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^\w\s-]/g, "")
          .trim().replace(/\s+/g, "-").toLowerCase();
      }
      function ensureAndDownload(url) {
        return fetch(url, { method: "HEAD", cache: "no-store" })
          .then(resp => { if (!resp.ok) throw 0; window.location.href = url; })
          .catch(() => alert("Arquivo ainda não está disponível. Tente novamente em alguns instantes."));
      }

      // Agrupa por card_title (título-raiz da página principal)
      function groupByCardTitle(blocks) {
        const map = new Map();
        for (const b of blocks) {
          const name = (b.card_title || "").trim() || (b.titulo || "").split(/\s+[—-]\s+/)[0].trim();
          const key = name;
          const slug = slugify(name);
          if (!map.has(key)) {
            map.set(key, { key, slug, name, tables: [], rows: 0, cols: 0 });
          }
          const g = map.get(key);
          g.tables.push(b);
          g.rows += Array.isArray(b.rows) ? b.rows.length : 0;
          g.cols = Math.max(g.cols, Array.isArray(b.columns) ? b.columns.length : 0);
        }
        return Array.from(map.values()).sort((a, b) => a.name.localeCompare(b.name, 'pt-BR'));
      }

      function renderList(groups, q = "") {
        const term = q.trim().toLowerCase();
        const filtered = term
          ? groups.filter(g => (g.name || "").toLowerCase().includes(term))
          : groups;

        $grid.innerHTML = "";
        if (!filtered.length) {
          $grid.insertAdjacentHTML("beforeend",
            `<div class="empty">Nenhuma instituição encontrada para “${q}”.</div>`);
        } else {
          filtered.forEach(g => {
            const href = `instituicao.html?g=${encodeURIComponent(g.slug)}`;
            const excelAll = `${DOWNLOADS_PATH}${ALL_XLSX_NAME}`;
            const card = `
              <article class="card" aria-label="${g.name}">
                <h3>${g.name}</h3>
                <div class="meta">
                  <span class="pill">${g.tables.length} tabela(s)</span>
                  <span class="pill">${g.rows} linha(s)</span>
                  <span class="pill">${g.cols} coluna(s)</span>
                </div>
                <div class="foot">
                  <a class="btn" href="${href}">Abrir</a>
                  <a class="btn alt js-extract" href="#" data-url="${excelAll}">Extrair</a>
                </div>
              </article>
            `;
            $grid.insertAdjacentHTML("beforeend", card);
          });

          $grid.querySelectorAll(".js-extract").forEach(a=>{
            a.addEventListener("click",(ev)=>{
              ev.preventDefault();
              const url = ev.currentTarget.getAttribute("data-url");
              ensureAndDownload(url);
            });
          });
        }
        $countHint.textContent = `${filtered.length} instituição(ões)`;
      }

      async function boot() {
        try {
          const resp = await fetch(jsonURL(), { cache: "no-store" });
          if (!resp.ok) throw new Error(`Falha ao carregar JSON (${resp.status})`);
          const payload = await resp.json();

          if ($updatedAt) $updatedAt.textContent = payload.updated_at_br || "—";

          const blocks = Array.isArray(payload.tabelas) ? payload.tabelas : [];
          const groups = groupByCardTitle(blocks);

          renderList(groups);

          $busca.addEventListener("input", (e) => renderList(groups, e.target.value));
          if ($btnExtrairTodos) {
            $btnExtrairTodos.onclick = () =>
              ensureAndDownload(`${DOWNLOADS_PATH}${ALL_XLSX_NAME}`);
          }
        } catch (err) {
          console.error("[HOME] Erro ao carregar os dados:", err);
          $grid.innerHTML = `<div class="empty">Erro ao carregar os dados. Tente novamente mais tarde.</div>`;
        }
      }

      document.readyState === "loading"
        ? document.addEventListener("DOMContentLoaded", boot)
        : boot();
    })();
  </script>
</body>
</html>

