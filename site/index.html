<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Concorrência para Residência Médica 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

  <script>
    window.CONCORRENCIA_CONFIG = {
      jsonPath: "data/concorrencia_2026.json",
      downloadsPath: "downloads/",
      allExcelFilename: "concorrencia_2026.xlsx"
    };
  </script>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <h1>Concorrência para Residência Médica 2026</h1>
      <div class="subtle">Atualizado em: <span id="updatedAt">—</span></div>
      <div class="actions">
        <button id="btnExtrairTodos" class="btn" type="button">Extrair todos</button>
      </div>
    </header>

    <div class="toolbar">
      <input id="busca" class="search" type="search" placeholder="Buscar instituição…" autocomplete="off" />
      <div class="muted" id="countHint">0 instituições</div>
    </div>

    <section id="grid" class="grid" aria-label="Lista de instituições"></section>
  </div>

<script>
(function () {
  const cfg = window.CONCORRENCIA_CONFIG || {};
  const JSON_REL = cfg.jsonPath || "data/concorrencia_2026.json";
  const DOWNLOADS_PATH = cfg.downloadsPath || "downloads/";
  const ALL_XLSX_NAME = cfg.allExcelFilename || "concorrencia_2026.xlsx";
  const emdash = /\s+—\s+|\s+-\s+/;

  const $updatedAt = document.getElementById("updatedAt");
  const $grid = document.getElementById("grid");
  const $busca = document.getElementById("busca");
  const $countHint = document.getElementById("countHint");
  const $btnExtrairTodos = document.getElementById("btnExtrairTodos");

  function repoBasePath() {
    const parts = location.pathname.split("/");
    return "/" + (parts[1] || "");
  }
  function jsonURL() {
    return `${location.origin}${repoBasePath()}/${JSON_REL}?v=${Date.now()}`;
  }

  // === agrupador igual ao que você já usava (por card_title, com fallback) ===
  function groupByCardTitle(blocks) {
    const map = new Map();
    for (const b of blocks) {
      const name = (b.card_title || "").trim() || (b.titulo || "").split(emdash)[0].trim();
      const key = name;
      const slug = slugify(name);
      if (!map.has(key)) map.set(key, { key, slug, name, tables: [], rows: 0, cols: 0 });
      const g = map.get(key);
      g.tables.push(b);
      g.rows += Array.isArray(b.rows) ? b.rows.length : 0;
      g.cols = Math.max(g.cols, Array.isArray(b.columns) ? b.columns.length : 0);
    }
    return Array.from(map.values()).sort((a, b) => a.name.localeCompare(b.name, "pt-BR"));
  }

  // === utilidades ===
  function slugify(s) {
    return (s || "")
      .toString()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^\w\s-]/g, "")
      .trim().replace(/\s+/g, "-")
      .toLowerCase();
  }

  // mesmo padrão do scraper para nome de arquivo
  function fileNameFromTitle(title) {
    const base = (title || "").toString().replace(/[^\w\s-]/g, "_").trim() || "tabela";
    const cut = base.length > 40 ? base.slice(0, 40) : base;
    return `${cut}.xlsx`;
  }

  // download robusto (URL-encode + retries)
  async function ensureAndDownload(url, tries = 3, delay = 900) {
    const encoded = url.split("/").map((p, i) => (i === 0 ? p : encodeURIComponent(p))).join("/");
    for (let i = 0; i < tries; i++) {
      try {
        const r = await fetch(encoded, { method: "HEAD", cache: "no-store" });
        if (r.ok) { location.href = encoded; return; }
      } catch (_) {}
      await new Promise(res => setTimeout(res, delay * Math.pow(1.25, i)));
    }
    alert("Arquivo ainda não está disponível. Tente novamente em instantes.");
  }

  function renderList(groups, q = "") {
    const term = q.trim().toLowerCase();
    const filtered = term ? groups.filter(g => (g.name || "").toLowerCase().includes(term)) : groups;

    $grid.innerHTML = "";
    if (!filtered.length) {
      $grid.insertAdjacentHTML("beforeend",
        `<div class="empty">Nenhuma instituição encontrada para “${q}”.</div>`);
    } else {
      filtered.forEach(g => {
        const href = `instituicao.html?g=${encodeURIComponent(g.slug)}`;
        const card = `
          <article class="card" aria-label="${g.name}">
            <h3>${g.name}</h3>
            <div class="meta">
              <span class="pill">${g.tables.length} tabela(s)</span>
              <span class="pill">${g.rows} linha(s)</span>
              <span class="pill">${g.cols} coluna(s)</span>
            </div>
            <div class="foot">
              <a class="btn" href="${href}">Abrir</a>
              <button class="btn alt js-extract" type="button">Extrair</button>
            </div>
          </article>
        `;
        $grid.insertAdjacentHTML("beforeend", card);
        const btn = $grid.lastElementChild.querySelector(".js-extract");

        // >>> Extrair DO CARD: apenas os modelos dessa instituição
        btn.addEventListener("click", () => {
          g.tables.forEach((t, idx) => {
            const fn = fileNameFromTitle(t.titulo);
            setTimeout(() => ensureAndDownload(`${DOWNLOADS_PATH}${fn}`), idx * 350);
          });
        });
      });
    }
    $countHint.textContent = `${filtered.length} instituição(ões)`;
  }

  async function boot() {
    try {
      const resp = await fetch(jsonURL(), { cache: "no-store" });
      if (!resp.ok) throw new Error(`Falha ao carregar JSON (${resp.status})`);
      const payload = await resp.json();

      if ($updatedAt) $updatedAt.textContent = payload.updated_at_br || "—";

      const blocks = Array.isArray(payload.tabelas) ? payload.tabelas : [];
      const groups = groupByCardTitle(blocks);

      renderList(groups);
      $busca.addEventListener("input", (e) => renderList(groups, e.target.value));

      // >>> Extrair TODOS da home = consolidado geral (como já era)
      if ($btnExtrairTodos) {
        $btnExtrairTodos.onclick = () =>
          ensureAndDownload(`${DOWNLOADS_PATH}${ALL_XLSX_NAME}`);
      }
    } catch (err) {
      console.error("[HOME] Erro ao carregar os dados:", err);
      $grid.innerHTML = `<div class="empty">Erro ao carregar os dados. Tente novamente mais tarde.</div>`;
    }
  }

  document.readyState === "loading"
    ? document.addEventListener("DOMContentLoaded", boot)
    : boot();
})();
</script>


</body>
</html>






