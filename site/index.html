<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Concorrência para Residência Médica 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

  <script>
    window.CONCORRENCIA_CONFIG = {
      jsonPath: "data/concorrencia_2026.json",
      downloadsPath: "downloads/",
      allExcelFilename: "concorrencia_2026.xlsx"
    };
  </script>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <h1>Concorrência para Residência Médica 2026</h1>
      <div class="subtle">Atualizado em: <span id="updatedAt">—</span></div>
      <div class="actions">
        <button id="btnExtrairTodos" class="btn" type="button">Extrair todos</button>
      </div>
    </header>

    <div class="toolbar">
      <input id="busca" class="search" type="search" placeholder="Buscar instituição…" autocomplete="off" />
      <div class="muted" id="countHint">0 instituições</div>
    </div>

    <section id="grid" class="grid" aria-label="Lista de instituições"></section>
  </div>

<script>
(() => {
  const JSON_REL = "data/concorrencia_2026.json";
  const DOWNLOADS_PATH = "downloads/";
  const emdash = /\s+—\s+|\s+-\s+/;

  // === helpers ===
  function repoBasePath(){ const p=location.pathname.split("/"); return "/"+(p[1]||""); }
  function jsonURL(){ return `${location.origin}${repoBasePath()}/${JSON_REL}?v=${Date.now()}`; }
  function slugify(s){ return (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s-]/g,"").trim().replace(/\s+/g,"-").toLowerCase(); }
  function n(v){ return Array.isArray(v) ? v.length : (v||0); }

  // === nomes de arquivo 100% compatíveis com o scraper ===
  function fileNameFromTitle(title){
    const base = (title||"").toString().replace(/[^\w\s-]/g,"_").trim() || "tabela";
    const cut  = base.length > 40 ? base.slice(0,40) : base;
    return `${cut}.xlsx`;
  }

  // === download robusto (encode + retries) ===
  async function ensureAndDownload(url, tries=3, delay=900){
    const encoded = url.split("/").map((part,i)=> i===0?part:encodeURIComponent(part)).join("/");
    for (let i=0;i<tries;i++){
      try{
        const r = await fetch(encoded, {method:"HEAD", cache:"no-store"});
        if (r.ok){ location.href = encoded; return; }
      }catch(_){}
      await new Promise(res=>setTimeout(res, delay*Math.pow(1.25,i)));
    }
    alert("Arquivo ainda não está disponível. Tente novamente em instantes.");
  }

  // === agrupa por instituição (mesma regra do instituicao.html) ===
  function instFromTitle(title){
    const parts=(title||"").split(emdash);
    let base=(parts[0]||"").trim();
    if (/^(concorr[eê]ncia|programas|prova)/i.test(base) && parts.length>1){
      base = parts[parts.length-1].trim();
    }
    return (base||title||"").replace(/\b20\d{2}(?:\/20\d{2})?\b/g,"").replace(/\s{2,}/g," ").trim();
  }

  // === render ===
  const $grid = document.querySelector(".grid");
  const $count = document.getElementById("count");

  function render(groups){
    $grid.innerHTML = "";
    $count.textContent = `${groups.length} instituição(ões)`;

    groups.forEach(g=>{
      const totalRows = g.tables.reduce((acc,t)=>acc + n(t.rows),0);
      const totalCols = Math.max(...g.tables.map(t=>n(t.columns)||0));
      const pills = `
        <div class="meta">
          <span class="pill">${g.tables.length} tabela(s)</span>
          <span class="pill">${totalRows} linha(s)</span>
          <span class="pill">${totalCols} coluna(s)</span>
        </div>`;

      const card = document.createElement("article");
      card.className = "card";
      card.innerHTML = `
        <h3>${g.name}</h3>
        ${pills}
        <div class="foot">
          <a class="btn" href="instituicao.html?g=${g.slug}">Abrir</a>
          <button class="btn alt" type="button">Extrair</button>
        </div>
      `;

      // "Extrair" do CARD: baixa SOMENTE os modelos desta instituição
      card.querySelector(".btn.alt").addEventListener("click", () => {
        g.tables.forEach((t, idx) => {
          const fn = fileNameFromTitle(t.titulo);
          setTimeout(()=> ensureAndDownload(`downloads/${fn}`), idx*350);
        });
      });

      $grid.appendChild(card);
    });
  }

  async function boot(){
    const resp = await fetch(jsonURL(), {cache:"no-store"});
    const payload = await resp.json();
    const blocks = Array.isArray(payload.tabelas)? payload.tabelas : [];

    const map = new Map();
    blocks.forEach(b=>{
      const key = instFromTitle(b.titulo||"");
      const slug = slugify(key);
      if(!map.has(slug)) map.set(slug,{name:key, slug, tables:[]});
      map.get(slug).tables.push(b);
    });

    render([...map.values()]);
    document.getElementById("updatedAt").textContent = payload.updated_at_br || "—";

    // "Extrair todos" do topo = já estava correto (todos os modelos do site)
    document.getElementById("btnAll").onclick = (ev)=>{
      ev.preventDefault();
      // baixa o consolidado geral se existir, senão baixa todos individuais
      ensureAndDownload("downloads/concorrencia_2026.xlsx");
    };

    // filtro
    const $search = document.getElementById("search");
    $search.addEventListener("input", e=>{
      const q = e.target.value.toLowerCase().trim();
      [...$grid.children].forEach(card=>{
        const name = card.querySelector("h3").textContent.toLowerCase();
        card.style.display = name.includes(q) ? "" : "none";
      });
    });
  }

  document.readyState==="loading" ? document.addEventListener("DOMContentLoaded",boot) : boot();
})();
</script>

</body>
</html>





