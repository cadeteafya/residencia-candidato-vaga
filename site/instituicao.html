<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Instituição • Concorrência 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />
  <style>
    .container { max-width: 980px; margin: 26px auto 60px; padding: 0 16px }
    .page-header { padding: 22px 18px; border-radius: 12px; background: var(--card); }
    .page-header h1 { margin: 0 0 4px; font-size: 1.6rem }
    .subtle { color: var(--muted); font-size: .92rem }
    .row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px }
    .btn { padding: 10px 14px; border-radius: 10px; background: var(--primary); color: #fff; border: 0; cursor: pointer; text-decoration: none; display: inline-block }
    .btn.alt { background: transparent; color: var(--text); border: 1px solid var(--border) }
    .btn.ghost { background: transparent; color: var(--muted); border: 1px dashed var(--border) }
    .muted { color: var(--muted) }
    .section { margin-top: 18px }
    .section h2 { margin: 0 0 10px; font-size: 1.15rem }
    .table-wrap { overflow: auto; border: 1px solid var(--border); border-radius: 12px; }
    table { width: 100%; border-collapse: collapse }
    thead th { text-align: left }
    th, td { padding: 12px 14px; border-top: 1px solid var(--border) }
    thead th { border-top: 0 }
    .empty { margin: 24px 0; color: var(--muted) }
  </style>
  <script>
    window.CONCORRENCIA_CONFIG = {
      jsonPath: "data/concorrencia_2026.json",
      downloadsPath: "downloads/",
      allExcelFilename: "concorrencia_2026.xlsx",
      fonteUrl: "https://med.estrategia.com/portal/residencia-medica/concorrencia-residencia-medica/"
    };
  </script>
</head>
<body>
  <div class="container">
    <header class="page-header">
      <div class="row">
        <a href="./" class="btn alt" aria-label="Voltar para a página inicial">← Voltar</a>
        <a id="btnExtrairTodos" class="btn ghost" href="#" role="button">Extrair todos</a>
      </div>
      <h1 id="titulo">Instituição</h1>
      <div class="subtle">Atualizado em: <span id="updatedAt">—</span></div>
      <div class="row">
        <a id="linkFonte" class="btn alt" target="_blank" rel="noopener">Ver fonte</a>
      </div>
    </header>

    <section id="conteudo"></section>

    <p class="muted" style="margin-top: 22px;">
      Dados consolidados automaticamente a partir do Estratégia MED.
      Dúvidas? <a href="mailto:ricardo.cadete@afya.com.br">ricardo.cadete@afya.com.br</a>
    </p>
  </div>

  <script>
    (function () {
      const cfg = window.CONCORRENCIA_CONFIG || {};
      const JSON_REL = cfg.jsonPath || "data/concorrencia_2026.json";
      const DOWNLOADS_PATH = cfg.downloadsPath || "downloads/";
      const ALL_XLSX_NAME = cfg.allExcelFilename || "concorrencia_2026.xlsx";

      const emdash = /\s+—\s+|\s+-\s+/;

      const $titulo = document.getElementById("titulo");
      const $updatedAt = document.getElementById("updatedAt");
      const $conteudo = document.getElementById("conteudo");
      const $btnExtrairTodos = document.getElementById("btnExtrairTodos");
      const $linkFonte = document.getElementById("linkFonte");

      function repoBasePath() {
        const parts = location.pathname.split("/");
        return "/" + (parts[1] || "");
      }
      function jsonURL() {
        return `${location.origin}${repoBasePath()}/${JSON_REL}?v=${Date.now()}`;
      }
      function q(key) {
        const p = new URLSearchParams(location.search);
        return p.get(key) || "";
      }
      function slugify(s) {
        return (s || "").toString()
          .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
          .replace(/[^\w\s-]/g, "")
          .trim().replace(/\s+/g, "-").toLowerCase();
      }
      function instKey(title) {
        const parts = (title || "").split(emdash);
        return (parts[0] || "").trim() || (title || "").trim();
      }
      function subTitle(full, base) {
        const parts = (full || "").split(emdash);
        if (parts.length >= 2) return parts.slice(1).join(" — ").trim();
        // quando não há subtítulo, repete o nome da instituição?
        return ""; // fica sem subtítulo
      }
      function sanitizeFileNameFromTitle(title) {
        const base = (title || "").toString().replace(/[^\w\s-]/g, "_").trim() || "tabela";
        const cut = base.length > 40 ? base.slice(0, 40) : base;
        return `${cut}.xlsx`;
      }
      function ensureAndDownload(url) {
        return fetch(url, { method: "HEAD", cache: "no-store" })
          .then(resp => { if (!resp.ok) throw 0; window.location.href = url; })
          .catch(() => alert("Arquivo ainda não está disponível. Tente novamente em alguns instantes."));
      }

      function renderTables(instName, tables, updatedText) {
        $titulo.textContent = instName;
        $updatedAt.textContent = updatedText || "—";
        if ($linkFonte && cfg.fonteUrl) $linkFonte.href = cfg.fonteUrl;

        if (!tables.length) {
          $conteudo.innerHTML = `<div class="empty">Tabela não encontrada. Volte e escolha outra instituição.</div>`;
          return;
        }

        $conteudo.innerHTML = "";
        tables.forEach(t => {
          const sub = subTitle(t.titulo, instName);
          const filename = sanitizeFileNameFromTitle(t.titulo);
          const columns = Array.isArray(t.columns) ? t.columns : [];
          const rows = Array.isArray(t.rows) ? t.rows : [];

          const thead = `<thead><tr>${columns.map(c => `<th>${c}</th>`).join("")}</tr></thead>`;
          const tbody = `<tbody>${
            rows.map(r => `<tr>${columns.map((_, i) => `<td>${(r[i] ?? "")}</td>`).join("")}</tr>`).join("")
          }</tbody>`;

          const titleHtml = sub ? `<h2>${sub}</h2>` : "";

          const section = `
            <section class="section">
              ${titleHtml}
              <div class="table-wrap">
                <table aria-label="${t.titulo}">
                  ${thead}${tbody}
                </table>
              </div>
              <div class="row" style="margin-top:10px">
                <a class="btn" href="${DOWNLOADS_PATH}${filename}" onclick="return false"
                   data-dl="${filename}">Extrair esta tabela</a>
              </div>
            </section>
          `;
          $conteudo.insertAdjacentHTML("beforeend", section);
        });

        // bind dos botões de download individuais
        $conteudo.querySelectorAll('[data-dl]').forEach(a => {
          a.addEventListener("click", (ev) => {
            const fn = ev.currentTarget.getAttribute("data-dl");
            ensureAndDownload(`${DOWNLOADS_PATH}${fn}`);
          });
        });

        if ($btnExtrairTodos) {
          $btnExtrairTodos.onclick = () =>
            ensureAndDownload(`${DOWNLOADS_PATH}${ALL_XLSX_NAME}`);
        }
      }

      async function boot() {
        const groupSlug = q("g");
        try {
          const resp = await fetch(jsonURL(), { cache: "no-store" });
          if (!resp.ok) throw new Error(`Falha ao carregar JSON (${resp.status})`);
          const payload = await resp.json();

          const blocks = Array.isArray(payload.tabelas) ? payload.tabelas : [];
          const updatedText = payload.updated_at_br || "—";

          // encontra grupo pela slug do nome da instituição
          const groupsMap = new Map();
          blocks.forEach(b => {
            const key = instKey(b.titulo || "");
            const slug = slugify(key);
            if (!groupsMap.has(slug)) groupsMap.set(slug, { name: key, tables: [] });
            groupsMap.get(slug).tables.push(b);
          });

          const group = groupsMap.get(groupSlug);
          if (!group) {
            $titulo.textContent = "Instituição";
            $conteudo.innerHTML = `<div class="empty">Instituição não encontrada.</div>`;
            return;
          }

          renderTables(group.name, group.tables, updatedText);
        } catch (err) {
          console.error("[INSTITUIÇÃO] Erro ao carregar os dados:", err);
          $conteudo.innerHTML = `<div class="empty">Erro ao carregar os dados. Tente novamente mais tarde.</div>`;
        }
      }

      document.readyState === "loading"
        ? document.addEventListener("DOMContentLoaded", boot)
        : boot();
    })();
  </script>
</body>
</html>
