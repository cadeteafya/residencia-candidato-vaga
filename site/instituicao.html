<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Instituição • Concorrência 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

</head>
<body class="instituicao">
  <div class="container">
    <div class="topbar">
      <a href="./" class="btn alt">← Voltar</a>
    </div>

    <header class="hdr">
      <h1 id="titulo">Instituição</h1>
      <div class="muted">Atualizado em: <span id="updatedAt">—</span></div>
      <div><a id="btnExtrairTodos" class="btn ghost" href="#" role="button">Extrair todos</a></div>
    </header>

    <section id="conteudo"></section>
  </div>

<script>
(() => {
  const JSON_REL = "data/concorrencia_2026.json";
  const DOWNLOADS_PATH = "downloads/";
  const ALL_XLSX_NAME = "concorrencia_2026.xlsx"; // (permanece para eventual uso)

  const $titulo = document.getElementById("titulo");
  const $updatedAt = document.getElementById("updatedAt");
  const $conteudo = document.getElementById("conteudo");
  const $btnAll = document.getElementById("btnExtrairTodos");

  // utils iguais às do index/scraper
  const EMDASH = /\s+—\s+|\s+-\s+/;
  const YEAR = /\b20\d{2}(?:\/20\d{2})?\b/;

  function instFromTitle(title) {
    const t = (title || "").trim();
    if (!t) return "Instituição";
    const parts = t.split(EMDASH);
    let base = (parts[0] || "").trim();
    if (/^(concorr[eê]ncia|relação candidato\/vaga|programas|prova)/i.test(base) && parts.length > 1) {
      base = parts[parts.length - 1].trim();
    }
    base = base.replace(YEAR, "").replace(/^[\W_]+/, "").replace(/\s{2,}/g, " ").trim();
    return base || t;
  }

  function slugify(s) {
    return (s || "")
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^\w\s-]/g, "")
      .trim().toLowerCase()
      .replace(/\s+/g, "-");
  }

  function packInstitutionXlsxBySlug(slug) {
    return `concorrencia_2026__${slug}.xlsx`;
  }

  function perTableFilenameFromTitle(title) {
    let base = (title || "").replace(/[^\w\s-]/g, "_").trim();
    if (!base) base = "tabela";
    if (base.length > 40) base = base.slice(0, 40);
    return `${base}.xlsx`;
  }

  function ensureAndDownload(url) {
    return fetch(url, { method: "HEAD", cache: "no-store" })
      .then(r => { if (!r.ok) throw 0; window.location.href = url; })
      .catch(() => alert("Arquivo ainda não está disponível. Tente novamente em instantes."));
  }

  function q(key) {
    const p = new URLSearchParams(location.search);
    return p.get(key) || "";
  }

  function groupByInstitution(blocks) {
    const map = new Map();
    for (const b of blocks) {
      const name = instFromTitle(b.titulo || "");
      const slug = slugify(name);
      if (!map.has(slug)) map.set(slug, { slug, name, tables: [] });
      map.get(slug).tables.push(b);
    }
    return map;
  }

  function renderTables(group, updatedText) {
    $titulo.textContent = group.name;
    $updatedAt.textContent = updatedText || "—";
    $conteudo.innerHTML = "";

    // botão "Extrair todos" desta instituição
    if ($btnAll) {
      $btnAll.onclick = (ev) => {
        ev.preventDefault();
        ensureAndDownload(`${DOWNLOADS_PATH}${packInstitutionXlsxBySlug(group.slug)}`);
      };
    }

    for (const t of group.tables) {
      const cols = Array.isArray(t.columns) ? t.columns : [];
      const rows = Array.isArray(t.rows) ? t.rows : [];
      const thead = `<thead><tr>${cols.map(c => `<th>${c}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${rows.map(r => `<tr>${cols.map((_, i) => `<td>${r[i] ?? ""}</td>`).join("")}</tr>`).join("")}</tbody>`;

      const file = perTableFilenameFromTitle(t.titulo);

      const section = `
        <section class="section">
          <h2>${t.titulo}</h2>
          <div class="table-wrap"><table aria-label="${t.titulo}">${thead}${tbody}</table></div>
          <div class="row"><a class="btn" href="${DOWNLOADS_PATH}${file}" data-dl="${file}">Extrair esta tabela</a></div>
        </section>
      `;
      $conteudo.insertAdjacentHTML("beforeend", section);
    }

    // binds "Extrair esta tabela"
    $conteudo.querySelectorAll("[data-dl]").forEach(a => {
      a.addEventListener("click", ev => {
        ev.preventDefault();
        ensureAndDownload(`${DOWNLOADS_PATH}${ev.currentTarget.getAttribute("data-dl")}`);
      });
    });
  }

  async function boot() {
    const slug = q("g");
    try {
      const resp = await fetch(JSON_REL, { cache: "no-store" });
      if (!resp.ok) throw new Error(`Falha ao carregar JSON (${resp.status})`);
      const payload = await resp.json();

      const blocks = Array.isArray(payload.tabelas) ? payload.tabelas : [];
      const groups = groupByInstitution(blocks);

      const group = groups.get(slug);
      if (!group) {
        $conteudo.innerHTML = `<div class="empty">Tabela não encontrada.</div>`;
        return;
      }
      renderTables(group, payload.updated_at_br);
    } catch (e) {
      console.error(e);
      $conteudo.innerHTML = `<div class="empty">Erro ao carregar os dados.</div>`;
    }
  }

  document.readyState === "loading" ? document.addEventListener("DOMContentLoaded", boot) : boot();
})();
</script>

</body>
</html>
