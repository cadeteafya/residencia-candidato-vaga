<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Instituição • Concorrência 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

</head>
<body class="instituicao">
  <div class="container">
    <div class="topbar">
      <a href="./" class="btn alt">← Voltar</a>
    </div>

    <header class="hdr">
      <h1 id="titulo">Instituição</h1>
      <div class="muted">Atualizado em: <span id="updatedAt">—</span></div>
      <div><a id="btnExtrairTodos" class="btn ghost" href="#" role="button">Extrair todos</a></div>
    </header>

    <section id="conteudo"></section>
  </div>

  <script>
  (() => {
    const JSON_REL = "data/concorrencia_2026.json";
    const DOWNLOADS_PATH = "downloads/";
    const ALL_XLSX_NAME = "concorrencia_2026.xlsx";
    const emdash = /\s+—\s+|\s+-\s+/;

    const $titulo = document.getElementById("titulo");
    const $updatedAt = document.getElementById("updatedAt");
    const $conteudo = document.getElementById("conteudo");
    const $btnAll = document.getElementById("btnExtrairTodos");

    function repoBasePath(){ const p=location.pathname.split("/"); return "/"+(p[1]||""); }
    function jsonURL(){ return `${location.origin}${repoBasePath()}/${JSON_REL}?v=${Date.now()}`; }
    function q(key){ const p=new URLSearchParams(location.search); return p.get(key)||""; }
    function slugify(s){ return (s||"").toString().normalize("NFD").replace(/[\u0300-\u036f]/g,"").replace(/[^\w\s-]/g,"").trim().replace(/\s+/g,"-").toLowerCase(); }
    function cleanYears(s){ return (s||"").replace(/\b20\d{2}(?:\/20\d{2})?\b/g,"").replace(/\s{2,}/g," ").trim(); }
    function instFromTitle(title){
      const parts=(title||"").split(emdash);
      let base=(parts[0]||"").trim();
      if (/^(concorr[eê]ncia|programas|prova)/i.test(base) && parts.length>1){
        base = parts[parts.length-1].trim();
      }
      return cleanYears(base) || (title||"").trim();
    }
    function subTitle(full, inst){
      const parts=(full||"").split(emdash);
      if (parts.length>=2) return parts.slice(1).join(" — ").trim();
      return "";
    }
    function sanitizeFileNameFromTitle(title){
      const base=(title||"").toString().replace(/[^\w\s-]/g,"_").trim() || "tabela";
      return `${(base.length>40? base.slice(0,40):base)}.xlsx`;
    }
    function ensureAndDownload(url){
      return fetch(url,{method:"HEAD",cache:"no-store"})
        .then(r=>{ if(!r.ok) throw 0; location.href=url; })
        .catch(()=>alert("Arquivo ainda não está disponível. Tente novamente em instantes."));
    }

    function renderTables(instName, tables, updatedText){
      $titulo.textContent = instName;
      $updatedAt.textContent = updatedText || "—";
      $conteudo.innerHTML = "";

      if(!tables.length){
        $conteudo.innerHTML = `<div class="empty">Tabela não encontrada.</div>`;
        return;
      }

      tables.forEach(t=>{
        const sub = subTitle(t.titulo, instName);
        const filename = sanitizeFileNameFromTitle(t.titulo);
        const columns = Array.isArray(t.columns)? t.columns : [];
        const rows = Array.isArray(t.rows)? t.rows : [];

        const thead = `<thead><tr>${columns.map(c=>`<th>${c}</th>`).join("")}</tr></thead>`;
        const tbody = `<tbody>${
          rows.map(r=>`<tr>${columns.map((_,i)=>`<td>${(r[i]??"")}</td>`).join("")}</tr>`).join("")
        }</tbody>`;

        const section = `
          <section class="section">
            ${sub ? `<h2>${sub}</h2>` : ""}
            <div class="table-wrap"><table aria-label="${t.titulo}">${thead}${tbody}</table></div>
            <div class="row"><a class="btn" href="${DOWNLOADS_PATH}${filename}" data-dl="${filename}">Extrair esta tabela</a></div>
          </section>`;
        $conteudo.insertAdjacentHTML("beforeend", section);
      });

      // bind downloads
      $conteudo.querySelectorAll("[data-dl]").forEach(a=>{
        a.addEventListener("click", (ev)=>{
          ev.preventDefault();
          const fn = ev.currentTarget.getAttribute("data-dl");
          ensureAndDownload(`${DOWNLOADS_PATH}${fn}`);
        });
      });

      if ($btnAll){
        $btnAll.onclick = (ev)=>{ ev.preventDefault(); ensureAndDownload(`${DOWNLOADS_PATH}${ALL_XLSX_NAME}`); };
      }
    }

    async function boot(){
      const groupSlug = q("g");
      try{
        const resp=await fetch(jsonURL(),{cache:"no-store"});
        const payload=await resp.json();
        const blocks=Array.isArray(payload.tabelas)? payload.tabelas : [];
        const updatedText = payload.updated_at_br || "—";

        const groups = new Map();
        blocks.forEach(b=>{
          const key = instFromTitle(b.titulo||"");
          const slug = slugify(key);
          if(!groups.has(slug)) groups.set(slug,{name:key,tables:[]});
          groups.get(slug).tables.push(b);
        });

        const group = groups.get(groupSlug);
        if(!group){
          $conteudo.innerHTML = `<div class="empty">Instituição não encontrada.</div>`;
          return;
        }
        renderTables(group.name, group.tables, updatedText);
      }catch(e){
        console.error(e);
        $conteudo.innerHTML = `<div class="empty">Erro ao carregar os dados.</div>`;
      }
    }

    document.readyState==="loading"? document.addEventListener("DOMContentLoaded",boot):boot();
  })();
  </script>
</body>
</html>
