<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Instituição • Concorrência 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

</head>
<body class="instituicao">
  <div class="container">
    <div class="topbar">
      <a href="./" class="btn alt">← Voltar</a>
    </div>

    <header class="hdr">
      <h1 id="titulo">Instituição</h1>
      <div class="muted">Atualizado em: <span id="updatedAt">—</span></div>
      <div><a id="btnExtrairTodos" class="btn ghost" href="#" role="button">Extrair todos</a></div>
    </header>

    <section id="conteudo"></section>
  </div>

<script>
(() => {
  const JSON_REL = "data/concorrencia_2026.json";
  const DOWNLOADS_PATH = "downloads/";
  const ALL_XLSX_NAME = "concorrencia_2026.xlsx"; // (não usado aqui, mas mantido)

  const $titulo   = document.getElementById("titulo");
  const $updated  = document.getElementById("updatedAt");
  const $conteudo = document.getElementById("conteudo");
  const $btnAll   = document.getElementById("btnExtrairTodos");

  function repoBasePath(){ const p=location.pathname.split("/"); return "/"+(p[1]||""); }
  function jsonURL(){ return `${location.origin}${repoBasePath()}/${JSON_REL}?v=${Date.now()}`; }
  function q(key){ const p=new URLSearchParams(location.search); return p.get(key)||""; }

  const EMDASH = /\s+[—-]\s+/;
  const YEAR   = /\b20\d{2}(?:\/20\d{2})?\b/g;
  const GENERIC = /^(concorr[eê]ncia|relação candidato\/vaga|programas|prova)/i;

  function nrm(s){ return (s||"").replace(/\s+/g," ").trim(); }
  function instFromTitle(title){
    let t = nrm(title);
    if(!t) return "Instituição";
    const parts = t.split(EMDASH);
    let base = (parts[0]||"").trim();
    if (GENERIC.test(base) && parts.length>1) base = parts[parts.length-1].trim();
    base = base.replace(YEAR,"").replace(/^[\W_]+/,"").trim();
    return base || t;
  }
  function slugify(s){
    return (s||"").normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^\w\s-]/g,"").trim().replace(/\s+/g,"-").toLowerCase();
  }
  function packFilenameByInst(instName){
    return `concorrencia_2026__${slugify(instName)}.xlsx`;
  }

  function subTitle(full, inst){
    // mantém só a parte após o em-dash, para usar como <h2>
    const parts = (full||"").split(EMDASH);
    if (parts.length>=2) return parts.slice(1).join(" — ").trim();
    return "";
  }

  function renderTables(instName, tables, updatedText){
    $titulo.textContent = instName;
    $updated.textContent = updatedText || "—";
    $conteudo.innerHTML = "";

    if(!tables.length){
      $conteudo.innerHTML = `<div class="empty">Tabela não encontrada.</div>`;
      return;
    }

    for(const t of tables){
      const sub = subTitle(t.titulo, instName);
      const cols = Array.isArray(t.columns) ? t.columns : [];
      const rows = Array.isArray(t.rows) ? t.rows : [];

      const thead = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${
        rows.map(r=>`<tr>${cols.map((_,i)=>`<td>${(r[i]??"")}</td>`).join("")}</tr>`).join("")
      }</tbody>`;

      const oneName = (t.titulo||"").replace(/[^\w\s-]/g,"_").trim();
      const fileOne = `${oneName.slice(0,40)||"tabela"}.xlsx`; // já gerado pelo scraper
      const section = `
        <section class="section">
          ${sub ? `<h2>${sub}</h2>` : ""}
          <div class="table-wrap"><table aria-label="${t.titulo}">${thead}${tbody}</table></div>
          <div class="row"><a class="btn" href="${DOWNLOADS_PATH}${fileOne}" download>Extrair esta tabela</a></div>
        </section>`;
      $conteudo.insertAdjacentHTML("beforeend", section);
    }

    // botão "Extrair todos" — pacote da instituição
    if($btnAll){
      const pack = DOWNLOADS_PATH + packFilenameByInst(instName);
      $btnAll.addEventListener("click", (e)=>{ e.preventDefault(); window.location.href = pack; });
    }
  }

  async function boot(){
    const groupSlug = q("g");
    try{
      const r = await fetch(jsonURL(), {cache:"no-store"});
      const payload = await r.json();
      const blocks = Array.isArray(payload.tabelas)? payload.tabelas : [];
      const updatedText = payload.updated_at_br || "—";

      // agrupa por instituição (mesma regra da home)
      const groups = new Map();
      for(const b of blocks){
        const key = instFromTitle(b.titulo||"");
        const slug = slugify(key);
        if(!groups.has(slug)) groups.set(slug, { name:key, tables:[] });
        groups.get(slug).tables.push(b);
      }

      const group = groups.get(groupSlug);
      if(!group){
        $conteudo.innerHTML = `<div class="empty">Instituição não encontrada.</div>`;
        return;
      }
      renderTables(group.name, group.tables, updatedText);
    }catch(err){
      console.error(err);
      $conteudo.innerHTML = `<div class="empty">Erro ao carregar os dados.</div>`;
    }
  }

  document.readyState==="loading" ? document.addEventListener("DOMContentLoaded",boot) : boot();
})();
</script>



</body>
</html>
