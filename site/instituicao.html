<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Instituição • Concorrência 2026</title>
  <link rel="stylesheet" href="assets/css/styles.css" />

</head>
<body class="instituicao">
  <div class="container">
    <div class="topbar">
      <a href="./" class="btn alt">← Voltar</a>
    </div>

    <header class="hdr">
      <h1 id="titulo">Instituição</h1>
      <div class="muted">Atualizado em: <span id="updatedAt">—</span></div>
      <div><a id="btnExtrairTodos" class="btn ghost" href="#" role="button">Extrair todos</a></div>
    </header>

    <section id="conteudo"></section>
  </div>

<script>
(() => {
  const JSON_REL       = "data/concorrencia_2026.json";
  const DOWNLOADS_PATH = "downloads/";
  const emdash = /\s+—\s+|\s+-\s+/;

  const $titulo    = document.getElementById("titulo");
  const $updatedAt = document.getElementById("updatedAt");
  const $conteudo  = document.getElementById("conteudo");
  const $btnAll    = document.getElementById("btnExtrairTodos");

  function repoBasePath(){ const p=location.pathname.split("/"); return "/"+(p[1]||""); }
  function jsonURL(){ return `${location.origin}${repoBasePath()}/${JSON_REL}?v=${Date.now()}`; }
  function q(key){ return new URLSearchParams(location.search).get(key)||""; }

  function slugify(s){
    return (s||"")
      .normalize("NFD").replace(/[\u0300-\u036f]/g,"")
      .replace(/[^\w\s-]/g,"")
      .trim().replace(/\s+/g,"-")
      .toLowerCase();
  }
  function cleanYears(s){
    return (s||"").replace(/\b20\d{2}(?:\/20\d{2})?\b/g,"").replace(/\s{2,}/g," ").trim();
  }
  function instFromTitle(title){
    let t = (title||"").split(emdash)[0].trim();
    t = t.replace(/^(concorr[eê]ncia|rel[aá]ci[oõ]n?o?.*vaga|programas?.*concorridos?|prova.*objetiva)\s*/i,"");
    t = t.replace(/\bresid[eê]ncia m[eé]dica\b/gi,"");
    t = cleanYears(t);
    return t || (title||"").trim();
  }
  function subTitle(full){
    const parts=(full||"").split(emdash);
    return parts.length>=2 ? parts.slice(1).join(" — ").trim() : "";
  }
  function sanitizeFileNameFromTitle(title){
    const base=(title||"").toString().replace(/[^\w\s-]/g,"_").trim() || "tabela";
    return `${(base.length>40? base.slice(0,40):base)}.xlsx`;
  }
  function ensureAndDownload(url){
    return fetch(url,{method:"HEAD",cache:"no-store"})
      .then(r=>{ if(!r.ok) throw 0; location.href=url; })
      .catch(()=>alert("Arquivo ainda não está disponível. Tente novamente em instantes."));
  }

  function renderTables(instName, tables, updatedText, groupSlug){
    $titulo.textContent = instName || "Instituição";
    $updatedAt.textContent = updatedText || "—";
    $conteudo.innerHTML = "";

    if(!tables.length){
      $conteudo.innerHTML = `<div class="empty">Tabela não encontrada.</div>`;
      return;
    }

    tables.forEach(t=>{
      const sub = subTitle(t.titulo);
      const filename = sanitizeFileNameFromTitle(t.titulo);
      const cols = Array.isArray(t.columns)? t.columns : [];
      const rows = Array.isArray(t.rows)? t.rows : [];

      const thead = `<thead><tr>${cols.map(c=>`<th>${c}</th>`).join("")}</tr></thead>`;
      const tbody = `<tbody>${rows.map(r=>`<tr>${cols.map((_,i)=>`<td>${(r[i]??"")}</td>`).join("")}</tr>`).join("")}</tbody>`;

      $conteudo.insertAdjacentHTML("beforeend", `
        <section class="section">
          ${sub ? `<h2>${sub}</h2>` : ""}
          <div class="table-wrap"><table aria-label="${t.titulo}">${thead}${tbody}</table></div>
          <div class="row"><a class="btn" href="${DOWNLOADS_PATH}${filename}" data-dl="${filename}">Extrair esta tabela</a></div>
        </section>
      `);
    });

    // binds
    $conteudo.querySelectorAll("[data-dl]").forEach(a=>{
      a.addEventListener("click",(ev)=>{
        ev.preventDefault();
        ensureAndDownload(`${DOWNLOADS_PATH}${ev.currentTarget.getAttribute("data-dl")}`);
      });
    });

    if ($btnAll){
      const urlGrp = `${DOWNLOADS_PATH}concorrencia_2026__${groupSlug}.xlsx`;
      $btnAll.onclick = (ev)=>{ ev.preventDefault(); ensureAndDownload(urlGrp); };
    }
  }

  async function boot(){
    const groupSlug = q("g");
    try{
      const resp = await fetch(jsonURL(), {cache:"no-store"});
      const payload = await resp.json();
      const blocks  = Array.isArray(payload.tabelas)? payload.tabelas : [];
      const updatedText = payload.updated_at_br || "—";

      // agrupa com a MESMA regra do index
      const groups = new Map();
      for (const b of blocks){
        const name = instFromTitle(b.card_title || b.titulo || "");
        const slug = slugify(name);
        if (!groups.has(slug)) groups.set(slug, {name, tables:[]});
        groups.get(slug).tables.push(b);
      }

      const g = groups.get(groupSlug);
      if (!g){ $conteudo.innerHTML = `<div class="empty">Instituição não encontrada.</div>`; return; }
      renderTables(g.name, g.tables, updatedText, groupSlug);
    }catch(e){
      console.error(e);
      $conteudo.innerHTML = `<div class="empty">Erro ao carregar os dados.</div>`;
    }
  }

  document.readyState==="loading" ? document.addEventListener("DOMContentLoaded",boot) : boot();
})();
</script>


</body>
</html>
